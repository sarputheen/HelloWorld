version: 2.1

# Define the jobs we want to run for this project
jobs:
  android:
    docker:
            - image: circleci/android:api-30
            
    environment:
      
      ANDROID_SDK_ROOT: /usr/local/Caskroom/android-sdk/4333796
    steps:
      - checkout
      - run: java --version
      - run: echo $JAVA_HOME
      - run:
                name: Install Node
                command: |
                    cd
                    curl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -
                    sudo apt-get install -y nodejs
                    
                    
      
      - run: |
          sudo apt update && sudo apt install android-sdk
          
          
      - run: |
          echo "y" | sdkmanager --install 'system-images;android-30;default;arm64-v8a'
          "no" | avdmanager create avd -n test -k "system-images;android-30;default;arm64-v8a" --force
          emulator -list-avd
          sdkmanager "platform-tools" "platforms;android-30"
      - run:
          name: Starting emulator in background
          command: |
                    cd ${ANDROID_HOME}/emulator;ls
                    export LD_LIBRARY_PATH=${ANDROID_HOME}/emulator/lib64:${ANDROID_HOME}/emulator/lib64/qt/lib
                    emulator -avd test_device -skin 1080x1920 -memory 1024 -engine qemu2 -netfast -no-audio -no-snapshot -accel on
          background: true
      - run: |
          
          adb devices
          echo "Emulator started"
      - run: |
          rm -rf node_modules
          npm cache clean --force
          rm -rf package-lock.json
      - run: npm install --save-dev
      - run: npm audit fix
      - run: npm install --save-dev chai
      - run:
          name: Starting metro in background
          command: npm start --reset-cache &> metro-android.log
          background: true
      - run: |
          react-native run-android &> build-android.log
          sleep 30
      - run:
          name: Run E2E Tests - Android
          command: npm run e2e-test:android -- Sanity &> test-execution-console-android.log
          no_output_timeout: 30m
      - store_artifacts:
          path: metro-android.log
          destination: metro-android.log
      - store_artifacts:
          path: build-android.log
          destination: build-android.log
      - store_artifacts:
          path: test-execution-console-android.log
          destination: test-execution-console-android.log
      - store_artifacts:
          path: __tests__/e2e/test-results
          destination: test-results-android

# Orchestrate our job run sequence
workflows:
  build_and_test:
    jobs:
      - android
